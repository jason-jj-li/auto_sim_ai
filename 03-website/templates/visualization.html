{% extends "base.html" %}

{% block title %}Data Visualization - CMD-BA-CNC{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-center mb-4">Data Visualization</h1>
            <p class="lead text-center">Interactive charts and analysis of the CMD-BA-CNC harmonization project</p>
            <hr class="my-4">
        </div>
    </div>

    <!-- Coverage Chart -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Biomarker Coverage Status
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Distribution of studies by their biomarker coverage completeness</p>
                    <div id="coverage-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Geographic Distribution -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-globe me-2"></i>
                        Geographic Distribution
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Global distribution of participating aging studies</p>
                    <div id="geographic-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample Size Comparison -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>
                        Sample Size Comparison
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Comparison of sample sizes across participating studies</p>
                    <div id="sample-size-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Chart -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Data Collection Timeline
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text">Timeline of data collection periods across studies</p>
                    <div id="timeline-chart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Studies Data Table -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        Studies Summary Table
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Study</th>
                                    <th>Country</th>
                                    <th>Sample Size</th>
                                    <th>Years</th>
                                    <th>CMD-BA Status</th>
                                    <th>Access Status</th>
                                </tr>
                            </thead>
                            <tbody id="studies-table-body">
                                <!-- Table content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Legend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title">Color Legend</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <span class="badge bg-success me-2">■</span>Complete 6-biomarker model
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning text-dark me-2">■</span>Partial coverage
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-danger me-2">■</span>Limited coverage
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-secondary me-2">■</span>Pending access
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex justify-content-center align-items-center" style="z-index: 9999; display: none !important;">
    <div class="text-center text-white">
        <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading visualization data...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading overlay
    function showLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
    }
    
    // Hide loading overlay
    function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
    }
    
    // Load coverage chart
    function loadCoverageChart() {
        fetch('/api/coverage_chart')
            .then(response => response.json())
            .then(data => {
                Plotly.newPlot('coverage-chart', data.data, data.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error loading coverage chart:', error);
                document.getElementById('coverage-chart').innerHTML = 
                    '<div class="alert alert-danger">Error loading coverage chart</div>';
            });
    }
    
    // Load geographic distribution chart
    function loadGeographicChart() {
        fetch('/api/geographic_distribution')
            .then(response => response.json())
            .then(data => {
                Plotly.newPlot('geographic-chart', data.data, data.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error loading geographic chart:', error);
                document.getElementById('geographic-chart').innerHTML = 
                    '<div class="alert alert-danger">Error loading geographic distribution chart</div>';
            });
    }
    
    // Load sample size chart
    function loadSampleSizeChart() {
        fetch('/api/sample_size_chart')
            .then(response => response.json())
            .then(data => {
                Plotly.newPlot('sample-size-chart', data.data, data.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error loading sample size chart:', error);
                document.getElementById('sample-size-chart').innerHTML = 
                    '<div class="alert alert-danger">Error loading sample size chart</div>';
            });
    }
    
    // Load timeline chart
    function loadTimelineChart() {
        fetch('/api/timeline_chart')
            .then(response => response.json())
            .then(data => {
                Plotly.newPlot('timeline-chart', data.data, data.layout, {responsive: true});
            })
            .catch(error => {
                console.error('Error loading timeline chart:', error);
                document.getElementById('timeline-chart').innerHTML = 
                    '<div class="alert alert-danger">Error loading timeline chart</div>';
            });
    }
    
    // Load studies data table
    function loadStudiesTable() {
        fetch('/api/studies_data')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('studies-table-body');
                tbody.innerHTML = '';
                
                Object.entries(data).forEach(([studyCode, study]) => {
                    const row = document.createElement('tr');
                    
                    // Status badge color
                    let statusClass = 'bg-secondary';
                    const status = study.cmd_ba_status.toLowerCase();
                    if (status.includes('complete')) {
                        statusClass = 'bg-success';
                    } else if (status.includes('partial')) {
                        statusClass = 'bg-warning text-dark';
                    } else if (status.includes('limited')) {
                        statusClass = 'bg-danger';
                    }
                    
                    row.innerHTML = `
                        <td><strong>${studyCode}</strong><br><small class="text-muted">${study.name}</small></td>
                        <td>${study.country}</td>
                        <td>${study.sample_size}</td>
                        <td>${study.years}</td>
                        <td><span class="badge ${statusClass}">${study.cmd_ba_status}</span></td>
                        <td><span class="badge ${study.access_status === 'Obtained' ? 'bg-success' : 'bg-secondary'}">${study.access_status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error loading studies table:', error);
                document.getElementById('studies-table-body').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading studies data</td></tr>';
            });
    }
    
    // Initialize all charts and data
    showLoading();
    
    Promise.all([
        loadCoverageChart(),
        loadGeographicChart(),
        loadSampleSizeChart(),
        loadTimelineChart(),
        loadStudiesTable()
    ]).finally(() => {
        hideLoading();
    });
    
    // Handle window resize for responsive charts
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('coverage-chart');
        Plotly.Plots.resize('geographic-chart');
        Plotly.Plots.resize('sample-size-chart');
        Plotly.Plots.resize('timeline-chart');
    });
});
</script>
{% endblock %}
